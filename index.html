<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js?a=1"></script>
    <script src="ace/ace.js" type="text/javascript" charset="utf-8"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" type="text/css" href="tooltips.css">
</head>

<body class="mixpanel-platform-body">

<div id="wrapper">
<div id="editor_wrapper">

    <div id="report_selector_menu">
        <strong>ARPDAU CQ</strong>
    </div>

    <div id="editor">
</div> <!-- weird formatting required for default code to look good -->

    <div id="controls">
        <table id="params_table">
            <tr>
                <th>
                    Dates to query: <a href="#" data-tooltip="This controls the `from_date` and `to_date` api parameters. We will only read data between these dates (inclusive)"><img src="question_mark.png" class="tooltip_questionmark" /></a>
                </th>
                <td><div id="dates"></div></td>
            </tr>
            <tr>
                <th>Script params: <a href="#" data-tooltip="This is a global variable `params` that will be available to your script. This lets your scripts be flexible. For example, if you were writing Segmentation, you might add an 'event_name' parameter and filter for `if (event.name == params.event_name)` to your script."><img src="question_mark.png" class="tooltip_questionmark" /></a></th>
                <td><textarea type="text" id="script_params" rows="5" columns="40"></textarea></td>
            </tr>
        </table>
        <button id="run_button">Run query</button>
        <div style="clear: both"></div>
    </div>
</div>

<br />

<div id="output"></div>
</div>

<script type="text/cq" id="cq">
function main() {
    return Events({
        from_date: "2015-10-05",
        to_date: "2015-11-02"
      })
      .filter(function(event) { return event.name === "Purchase" })
      .groupBy(
        [function(event) { return (new Date(event.time * 1000)).toISOString().split("T")[0] }], 
        mixpanel.reducer.sum(function(event) { return event["amount"] })
      );
    
}
  function runQuery() {
       
        var script = $('#cq').html();
        // trim all extra whitespace using jQuery trim
        script = $.trim(script);
        // grab the parameters from the inputs we defined
        
        MP.api.custom_query(script).done(function(results) {
            cqResult = results[0];
            console.log(cqResult)
        });
        
        
  }
     $(document).ready(function() {
      runQuery();
    });
    $('#dates').on('change', function() {
      runQuery();
    });
</script>


</body>
</html>
